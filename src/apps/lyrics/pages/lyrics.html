{% extends "templates/app.html" %}
{% block head %}
<style>
    html, body {
        overflow: hidden;
    }
    #lyrics {
        text-align: center;
        font-size: 20px;
        transition: transform 500ms;
        transform: translateY(50vh);
        width: calc(100% - 50px);
        padding-left: 25px;
        display: flex;
        flex-direction: column;
    }
    .lyric {
        transition: font-size 500ms;
        padding-bottom: 10px;
    }
    .lyric.current {
        font-size: 25px;
        font-weight: 999;
    }
</style>
{% endblock %}
{% block content %}
<div id="lyrics">
</div>
{% endblock %}
{% block script %}
<script>
    // copilot territory
    let automove = true;
    let timedLyrics = [];
    let currentIndex = -1;

    let basePos = 0;              // last reported position from "music"
    let playing = false;
    let lastSyncTs = performance.now();

    const lyricsInner = document.getElementById("lyrics");

    function normalizeLine(line) {
        return line === "" ? "â™¬" : line;
    }

    function setCurrentIndex(nextIndex) {
        if (nextIndex === currentIndex) return;

        if (currentIndex >= 0 && timedLyrics[currentIndex]) {
            timedLyrics[currentIndex].el.classList.remove("current");
        }

        currentIndex = nextIndex;

        if (currentIndex >= 0 && timedLyrics[currentIndex]) {
            const el = timedLyrics[currentIndex].el;
            el.classList.add("current");
            lyricsInner.style.transform = `translateY(calc(50vh - ${el.offsetTop}px))`;
        }
    }

    function findCurrentIndexByTime(t) {
        // Binary search: last line with time <= t
        let lo = 0;
        let hi = timedLyrics.length - 1;
        let ans = -1;

        while (lo <= hi) {
            const mid = (lo + hi) >> 1;
            if (timedLyrics[mid].time <= t) {
                ans = mid;
                lo = mid + 1;
            } else {
                hi = mid - 1;
            }
        }
        return ans;
    }

    on("lyrics", (lyr) => {
        lyricsInner.innerHTML = "";
        timedLyrics = [];
        automove = true;
        currentIndex = -1;

        if (!lyr) return;

        for (const rd of lyr) {
            const span = document.createElement("span");
            span.className = "lyric";

            if (typeof rd === "string") {
                automove = false;
                span.textContent = normalizeLine(rd);
            } else {
                const [time, text] = rd;
                span.textContent = normalizeLine(text);
                timedLyrics.push({ time, el: span });
            }

            lyricsInner.appendChild(span);
        }
    });

    on("music", (tpos) => {
        basePos = tpos[0];
        playing = tpos[1];
        lastSyncTs = performance.now();
    });

    function tick() {
        if (automove && timedLyrics.length) {
            const now = performance.now();
            const effectivePos = basePos + (playing ? (now - lastSyncTs) : 0);
            const idx = findCurrentIndexByTime(effectivePos);
            setCurrentIndex(idx);
        }
        requestAnimationFrame(tick);
    }

    requestAnimationFrame(tick);
    send("open", 0);
</script>
{% endblock %}